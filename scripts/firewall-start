#!/bin/sh
# Quiet & idempotent NAT redirect for sing-box (REDIRECT mode)

LAN_IF="$(nvram get lan_ifname 2>/dev/null)"; [ -z "$LAN_IF" ] && LAN_IF="br0"
SB_PORT=6543

# 1) Создать цепочку SBOX_NAT, если её нет (без лишних сообщений)
if ! iptables -t nat -nL SBOX_NAT >/dev/null 2>&1; then
  iptables -t nat -N SBOX_NAT >/dev/null 2>&1
fi

# 2) Гарантировать правильное содержимое цепочки (в нужном порядке)
#    Просто переформируем её тихо (это быстро и безопасно)
iptables -t nat -F SBOX_NAT >/dev/null 2>&1
iptables -t nat -A SBOX_NAT -m addrtype --dst-type LOCAL -j RETURN >/dev/null 2>&1
iptables -t nat -A SBOX_NAT -p tcp -j REDIRECT --to-ports "$SB_PORT" >/dev/null 2>&1

# 3) Убедиться, что PREROUTING на LAN_IF указывает на SBOX_NAT (если нет — добавить)
iptables -t nat -C PREROUTING -i "$LAN_IF" -p tcp -j SBOX_NAT >/dev/null 2>&1 || \
iptables -t nat -A PREROUTING -i "$LAN_IF" -p tcp -j SBOX_NAT >/dev/null 2>&1

# 4) (опционально) срезать QUIC, чтобы весь HTTPS шёл по TCP и редиректился
# iptables -t mangle -C PREROUTING -i "$LAN_IF" -p udp --dport 443 -j DROP >/dev/null 2>&1 || \
# iptables -t mangle -A PREROUTING -i "$LAN_IF" -p udp --dport 443 -j DROP >/dev/null 2>&1

# 5) Ничего не печатаем — «тихо»
exit 0